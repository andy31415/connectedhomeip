{% macro render_field(field) -%}{#
 Macro for the output of a single field entry such as:

 int16u identifyTime = 0;
 optional int16u transitionTime = 3;
 optional nullable int16u transitionTime = 2;
 optional ExtensionFieldSet extensionFieldSets[] = 5;
#}

{%- if field.qualities %}{{field.qualities | idltxt}} {% endif -%}
{{field.data_type.name}}
{%- if field.data_type.max_length -%} <{{field.data_type.max_length}}> {%- endif -%}
{##} {{field.name}}
{%- if field.is_list %}[]{% endif -%}
{##} = {{field.code}};
{%- endmacro -%}

{% macro render_struct(s) -%}{#
 Macro for the output of a complete struct
#}
  {%- if s.tag %}{{s.tag | idltxt}} {% endif -%}
  {% if s.qualities %}{{s.qualities | idltxt}} {% endif -%}
  struct {{s.name}} {##}
  {%- if s.code %}= {{s.code}} {% endif -%}
  {
    {% for field in s.fields %}
    {{render_field(field)}}
    {% endfor %}
  }
{%- endmacro -%}


// This IDL was auto-generated from a parsed data structure

{%  for cluster in idl.clusters %}

{% if cluster.description %}/** {{cluster.description}} */
{% endif %}

{{cluster.side | idltxt}} cluster {{cluster.name}} = {{cluster.code}} {
  {%- for enum in cluster.enums %}

  enum {{enum.name}} : {{ enum.base_type}} {
    {% for entry in enum.entries %}
    {{entry.name}} = {{entry.code}};
    {% endfor %}
  }
  {% endfor %}

  {%- for bitmap in cluster.bitmaps %}

  bitmap {{bitmap.name}} : {{ bitmap.base_type}} {
    {% for entry in bitmap.entries %}
    {{entry.name}} = {{entry.code}};
    {% endfor %}
  }
  {% endfor %}

  {%- for s in cluster.structs | rejectattr("tag") -%}
  {{render_struct(s)}}

  {% endfor %}

  {%- for e in cluster.events %}

  {% if e.qualities %}{{e.qualities | idltxt}} {% endif -%}
  {{e.priority | idltxt}} event {{e | event_access}}{{e.name}} = {{e.code}} {
    {% for field in e.fields %}
    {{render_field(field)}}
    {% endfor %}
  }

  {% endfor %}

  {%- for a in cluster.attributes %}
  {%- if loop.first %}

  {% endif %}
  {{a.qualities | idltxt}}attribute {{render_field(a.definition)}}
  {% endfor %}

  {%- for s in cluster.structs | selectattr("tag") %}
  {% if loop.first %}

  {% endif %}

  {{render_struct(s)}}
  {% endfor %}

  {%- for c in cluster.commands %}
  {% if loop.first %}

  {% endif %}
  {{c.qualities | idltxt}}command {{c | command_access}}{{c.name}}({{c.input_param}}): {{c.output_param}} = {{c.code}};
  {% endfor %}
}

{% endfor %}

{%- if idl.endpoints %}
{% for endpoint in idl.endpoints %}

endpoint {{endpoint.number}} {
  // FIXME: report endpoint
}
{%  endfor %}
{%  endif %}
